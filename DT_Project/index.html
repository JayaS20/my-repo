<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inclusive Smart Intercom Prototype</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #e0f7fa;
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding: 20px;
            flex-wrap: wrap;
        }
        .intercom {
            width: 420px;
            border: 2px solid #00acc1;
            padding: 15px;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin: 10px;
        }
        .screen {
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
            padding: 15px;
            margin-bottom: 15px;
            height: 220px;
            overflow-y: auto;
            font-size: 16px;
            border-radius: 10px;
        }
        .large-text {
            font-size: 24px;
            font-weight: bold;
            color: #01579b;
        }
        .leds {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }
        .led {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin: 0 8px;
            border: 2px solid #424242;
            transition: all 0.3s ease;
        }
        .led.green { background-color: #4caf50; }
        .led.yellow { background-color: #ffeb3b; }
        .led.red { background-color: #f44336; }
        .led.off { background-color: #9e9e9e; }
        .camera {
            text-align: center;
            margin-bottom: 15px;
            font-style: italic;
            color: #0277bd;
            cursor: pointer;
            background-color: #e1f5fe;
            padding: 10px;
            border-radius: 8px;
        }
        .speaker {
            text-align: left;
            margin-bottom: 15px;
            color: #0277bd;
        }
        .buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: #03a9f4;
            color: white;
            font-weight: bold;
            transition: background-color 0.3s;
            margin: 5px 0;
        }
        button.pressed {
            background-color: #01579b !important;
            box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.4);
            transform: translateY(2px);
        }
        button:hover {
            background-color: #0288d1;
        }
        .braille-label {
            font-size: 12px;
            color: #757575;
            display: block;
        }
        .wristband {
            width: 220px;
            border: 2px solid #00acc1;
            padding: 15px;
            background-color: #ffffff;
            border-radius: 15px;
            text-align: center;
            margin: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .wristband-screen {
            background-color: #212121;
            color: #76ff03;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        #visitor-options, #pre-recorded, #delivery-messages {
            margin-top: 15px;
        }
        #pre-recorded button, #delivery-messages button {
            display: block;
            width: 100%;
            margin: 8px 0;
        }
        video {
            width: 100%;
            height: auto;
            border-radius: 10px;
            margin-top: 10px;
        }
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border: 2px solid #00acc1;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }
        .popup.active {
            display: block;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.7.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>
    <div class="intercom" id="inside-intercom">
        <h2>Inside Intercom</h2>
        <div class="leds">
            <div class="led off" id="inside-green"></div>
            <div class="led off" id="inside-yellow"></div>
            <div class="led off" id="inside-red"></div>
        </div>
        <div class="camera" id="inside-camera">Camera (Click to Open)</div>
        <div class="camera" id="off-camera">Off Camera</div>
        <video id="inside-video" autoplay playsinline></video>
        <div class="screen large-text" id="inside-screen">
            Waiting for visitor...
        </div>
        <div class="speaker">Speaker (Audio Output)</div>
        <div class="buttons">
            <button id="inside-speak">Speak <span class="braille-label">(Braille: speak)</span></button>
            <button id="inside-message">Message <span class="braille-label">(Braille: msg)</span></button>
            <button id="inside-help">Help <span class="braille-label">(Braille: help)</span></button>
            <button id="add-face">Add Face <span class="braille-label">(Braille: face)</span></button>
            <button id="inside-language">Language <span class="braille-label">(Braille: lang)</span></button>
            <button id="inside-mode">Mode <span class="braille-label">(Braille: mode)</span></button>
        </div>
        <div id="pre-recorded">
            Pre-recorded Messages:
            <button onclick="sendMessage('Leave it outside, I\'ll pick it up, thank you')">Leave it outside...</button>
            <button onclick="sendMessage('Thank you')">Thank you</button>
            <button onclick="sendMessage('Wait')">Wait</button>
            <button onclick="sendMessage('Have a nice day')">Have a nice day</button>
            <button onclick="sendMessage('I\'m coming')">I'm coming</button>
            <button onclick="sendMessage('I need help with something')">I need help...</button>
        </div>
    </div>
    <div class="intercom" id="visitor-intercom">
        <h2>Visitor's Intercom</h2>
        <div class="leds">
            <div class="led off" id="visitor-green"></div>
            <div class="led off" id="visitor-yellow"></div>
            <div class="led off" id="visitor-red"></div>
        </div>
        <div class="camera" id="visitor-camera">Camera (Click to Open)</div>
        <video id="visitor-video" autoplay playsinline></video>
        <div class="screen large-text" id="visitor-screen">
            Select purpose...
        </div>
        <div class="speaker">Speaker (Audio Input/Output)</div>
        <div class="buttons">
            <button id="visitor-speak">Speak <span class="braille-label">(Braille: speak)</span></button>
        </div>
        <div id="visitor-options">
            Options:
            <button onclick="selectPurpose('Delivery')">Delivery</button>
            <button onclick="selectPurpose('Family Member')">Family Member</button>
            <button onclick="selectPurpose('Friend')">Friend</button>
            <button onclick="selectPurpose('Neighbour')">Neighbour</button>
        </div>
        <div id="delivery-messages" style="display: none;">
            Delivery Messages:
            <button onclick="sendDeliveryMessage('Parcel for you')">Parcel for you</button>
            <button onclick="sendDeliveryMessage('Please come outside')">Please come outside</button>
            <button onclick="sendDeliveryMessage('I have reached')">I have reached</button>
        </div>
    </div>
    <div class="wristband">
        <h3>Wristband</h3>
        <div class="wristband-screen" id="wristband-time">Time: 12:00 | Date: Oct 7</div>
        <div class="leds">
            <div class="led off" id="wristband-green"></div>
            <div class="led off" id="wristband-yellow"></div>
            <div class="led off" id="wristband-red"></div>
        </div>
        <button id="wristband-sos">SOS <span class="braille-label">(Braille: sos)</span></button>
        <div id="wristband-alert">Vibration Alert: Off</div>
    </div>
    <div class="popup" id="speak-popup">
        <p>You can speak now. Click Speak again to stop.</p>
        <button onclick="closePopup()">Close</button>
    </div>
    <script>
        const translations = {
    "has arrived": "வந்திருக்கிறார்",
    "Unknown person at the door": "தெரியாத நபர் வாசலில் வந்திருக்கார்",
    "Delivery person is at the door": "டெலிவரி நபர் வாசலில் உள்ளார்",
    "Parcel for you": "உங்களுக்கு பார்சல் எடுத்து வந்திருக்கிறேன்",
    "Please come outside": "தயவு செய்து வெளியே வாருங்கள்",
    "I have reached": "நான் வந்துவிட்டேன்",
    "Leave it outside, I'll pick it up, thank you": "அதை வெளியே வைக்கவும், நான் எடுத்துக் கொள்கிறேன், நன்றி",
    "Thank you": "நன்றி",
    "Wait": "காத்திருங்கள்",
    "Have a nice day": "இனிய நாளாக அமையட்டும்",
    "I'm coming": "நான் வருகிறேன்",
    "I need help with something": "எனக்கு ஒரு உதவி தேவை",
    "Fire Emergency Detected!": "தீ அபாயம் கண்டறியப்பட்டது!",
    "Universal Mode": "யுனிவர்சல் மோட்",
    "Visual Impairment Mode": "பார்வை குறைபாடு மோட்",
    "Hearing/Speech Impairment Mode": "கேட்டல்/பேச்சு குறைபாடு மோட்"
};
        let knownPeople = [];
        let currentLanguage = "English";
        let currentMode = "Universal";
        let visitorPurpose = "";
        let ledColor = "off";
        let mediaStream = null;
        let helpClickCount = 0;
        let helpTimer = null;
        let languageTapCount = 0;
        let languageTimer = null;
        let modelsLoaded = false;
        let faceDetectionInterval = null;
        let modeTapCount = 0;
        let modeTimer = null;

        async function loadModels() {
            try {
                document.getElementById('inside-screen').innerHTML += '<br>Loading face recognition...';
                console.log('Starting model loading...');
                
                // Try multiple CDN sources for better compatibility
                const MODEL_URLS = [
                    'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/',
                    'https://justadudewhohacks.github.io/face-api.js/models/'
                ];
                
                let loaded = false;
                for (const MODEL_URL of MODEL_URLS) {
                    try {
                        console.log('Trying to load models from:', MODEL_URL);
                        await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                        loaded = true;
                        console.log('✓ Models loaded successfully from:', MODEL_URL);
                        break;
                    } catch (e) {
                        console.log('✗ Failed to load from:', MODEL_URL);
                        console.error('Error:', e.message);
                    }
                }
                
                if (loaded) {
                    modelsLoaded = true;
                    document.getElementById('inside-screen').innerHTML = document.getElementById('inside-screen').innerHTML.replace('Loading face recognition...', 'Face recognition ready! ✓');
                } else {
                    throw new Error('All CDN sources failed');
                }
            } catch (err) {
                console.error('Model loading failed:', err);
                document.getElementById('inside-screen').innerHTML = document.getElementById('inside-screen').innerHTML.replace('Loading face recognition...', 'Face recognition unavailable ✗');
                modelsLoaded = false;
            }
        }
        
        // Load models after a short delay
        setTimeout(loadModels, 500);

        function speak(text, lang) {
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = (lang === "Tamil") ? "ta-IN" : "en-US";
            utter.volume = 1;
            utter.rate = 0.9;
            utter.pitch = 1;
            speechSynthesis.speak(utter);
        }

        function setLEDs(color) {
            ledColor = color || ['green', 'yellow', 'red'][Math.floor(Math.random() * 3)];
            document.querySelectorAll('.led').forEach(led => led.classList.remove('green', 'yellow', 'red', 'off'));
            if (color !== 'off') {
                document.getElementById('inside-' + ledColor).classList.add(ledColor);
                document.getElementById('visitor-' + ledColor).classList.add(ledColor);
                document.getElementById('wristband-' + ledColor).classList.add(ledColor);
                triggerWristbandAlert();
            } else {
                document.querySelectorAll('.led').forEach(led => led.classList.add('off'));
            }
        }

        function triggerWristbandAlert() {
            const message = ledColor === 'green' ? 'Known person' : ledColor === 'yellow' ? 'Delivery' : 'Emergency';
            document.getElementById('wristband-alert').textContent = `Vibration Alert: On (${message})`;
            setTimeout(() => {
                document.getElementById('wristband-alert').textContent = 'Vibration Alert: Off';
            }, 3000);
        }

        function setMode(mode) {
            currentMode = mode;
            const modeNames = {
                'Universal': 'Universal Mode',
                'Visual': 'Visual Impairment Mode',
                'Hearing': 'Hearing/Speech Impairment Mode'
            };
            const modeName = modeNames[mode];
            const translatedMode = currentLanguage === 'Tamil' ? translations[modeName] : modeName;
            document.getElementById('inside-screen').innerHTML += `<br>Mode: ${translatedMode}`;
            speak(translatedMode, currentLanguage);
            if (mode === 'Hearing' || mode === 'Universal') {
                triggerWristbandAlert();
            }
        }

        document.getElementById('add-face').addEventListener('click', async () => {
            if (!modelsLoaded) {
                document.getElementById('inside-screen').innerHTML += '<br>Face recognition not available. Please try later.';
                return;
            }
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                const name = prompt("Enter name (e.g., Ravi):");
                const category = prompt("Enter category (Family Member, Friend, Neighbour):");
                if (file && name && category && ['Family Member', 'Friend', 'Neighbour'].includes(category)) {
                    try {
                        const img = await faceapi.bufferToImage(file);
                        console.log('Attempting face detection on image...');
                        const detection = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                        if (detection) {
                            knownPeople.push({ name, category, descriptor: detection.descriptor });
                            console.log('Added person:', name, knownPeople.length);
                            document.getElementById('inside-screen').innerHTML += `<br>${name} (${category}) face added.`;
                        } else {
                            console.log('No face detected in image');
                            document.getElementById('inside-screen').innerHTML += '<br>No face detected in the image.';
                        }
                    } catch (err) {
                        console.error('Error processing image:', err);
                        document.getElementById('inside-screen').innerHTML += '<br>Error processing image: ' + err.message;
                    }
                } else {
                    document.getElementById('inside-screen').innerHTML += '<br>Invalid input or category! Use Family Member, Friend, or Neighbour.';
                }
            };
            input.click();
        });

        function selectPurpose(purpose) {
            visitorPurpose = purpose;
            document.getElementById('visitor-screen').innerHTML = `Purpose: ${purpose}<br>Waiting for response...`;
            if (purpose === 'Delivery') {
                document.getElementById('delivery-messages').style.display = 'block';
                simulateVisitorAtDoor(null, 'yellow');
            } else {
                document.getElementById('delivery-messages').style.display = 'none';
                // Only start face detection if camera is already open
                if (modelsLoaded && mediaStream) {
                    document.getElementById('visitor-screen').innerHTML = `Purpose: ${purpose}<br>Checking face...`;
                    checkFaceRecognitionOnce();
                } else {
                    simulateVisitorAtDoor(null, 'yellow');
                }
            }
        }

        function startContinuousFaceDetection() {
            if (faceDetectionInterval) {
                clearInterval(faceDetectionInterval);
            }
            checkFaceRecognition();
            faceDetectionInterval = setInterval(() => {
                checkFaceRecognition();
            }, 2000);
        }

        function stopContinuousFaceDetection() {
            if (faceDetectionInterval) {
                clearInterval(faceDetectionInterval);
                faceDetectionInterval = null;
            }
        }

        async function checkFaceRecognitionOnce() {
            if (!modelsLoaded || !mediaStream || knownPeople.length === 0) {
                console.log('Cannot check recognition: Models not loaded, no stream, or no known people');
                simulateVisitorAtDoor(null, 'yellow');
                return;
            }
            const video = document.getElementById('visitor-video');
            if (!video.videoWidth || video.readyState < 2) {
                console.log('Video not ready yet');
                setTimeout(() => checkFaceRecognitionOnce(), 500);
                return;
            }
            try {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({
                    inputSize: 416,
                    scoreThreshold: 0.5
                })).withFaceLandmarks().withFaceDescriptors();
                
                console.log('Detections:', detections.length);
                if (detections.length > 0) {
                    const faceDescriptor = detections[0].descriptor;
                    let bestMatch = null;
                    let bestDistance = 0.55;
                    
                    knownPeople.forEach(person => {
                        const distance = faceapi.euclideanDistance(faceDescriptor, person.descriptor);
                        console.log('Distance to', person.name, ':', distance);
                        if (distance < bestDistance) {
                            bestDistance = distance;
                            bestMatch = person;
                        }
                    });
                    
                    if (bestMatch) {
                        simulateVisitorAtDoor(bestMatch.name, 'green');
                        console.log('Recognized:', bestMatch.name, 'with distance:', bestDistance);
                    } else {
                        simulateVisitorAtDoor(null, 'yellow');
                        console.log('No match found. Best distance was:', bestDistance);
                    }
                } else {
                    console.log('No faces detected in video');
                    simulateVisitorAtDoor(null, 'yellow');
                }
            } catch (err) {
                console.error('Face detection error:', err);
                simulateVisitorAtDoor(null, 'yellow');
            }
        }

        async function checkFaceRecognition() {
            if (!modelsLoaded || !mediaStream || knownPeople.length === 0) {
                console.log('Cannot check recognition: Models not loaded, no stream, or no known people');
                simulateVisitorAtDoor(null, 'yellow');
                return;
            }
            const video = document.getElementById('visitor-video');
            if (!video.videoWidth || video.readyState < 2) {
                console.log('Video not ready yet');
                return;
            }
            try {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({
                    inputSize: 416,
                    scoreThreshold: 0.5
                })).withFaceLandmarks().withFaceDescriptors();
                
                console.log('Detections:', detections.length);
                if (detections.length > 0) {
                    const faceDescriptor = detections[0].descriptor;
                    let bestMatch = null;
                    let bestDistance = 0.55;
                    
                    knownPeople.forEach(person => {
                        const distance = faceapi.euclideanDistance(faceDescriptor, person.descriptor);
                        console.log('Distance to', person.name, ':', distance);
                        if (distance < bestDistance) {
                            bestDistance = distance;
                            bestMatch = person;
                        }
                    });
                    
                    if (bestMatch) {
                        simulateVisitorAtDoor(bestMatch.name, 'green');
                        console.log('Recognized:', bestMatch.name, 'with distance:', bestDistance);
                    } else {
                        simulateVisitorAtDoor(null, 'yellow');
                        console.log('No match found. Best distance was:', bestDistance);
                    }
                } else {
                    console.log('No faces detected in video');
                    simulateVisitorAtDoor(null, 'yellow');
                }
            } catch (err) {
                console.error('Face detection error:', err);
                simulateVisitorAtDoor(null, 'yellow');
            }
        }

       function simulateVisitorAtDoor(name = null, color = 'yellow') {
    let message = name ? `${name} has arrived` : "Unknown person at the door";
    if (visitorPurpose === 'Delivery') message = "Delivery person is at the door";
    const translated = currentLanguage === 'Tamil' ? 
        (name ? `${name} ${translations["has arrived"]}` : translations[message] || message) : 
        message;
    document.getElementById('inside-screen').innerHTML = `
        Visitor: ${translated}<br>
        Purpose: ${visitorPurpose || 'Unknown'}
    `;
    setLEDs(color);
    if (currentMode === 'Visual' || currentMode === 'Universal') speak(translated, currentLanguage);
    if (currentMode === 'Hearing' || currentMode === 'Universal') triggerWristbandAlert();
}

        function sendDeliveryMessage(message) {
            const translated = currentLanguage === 'Tamil' ? translations[message] : message;
            document.getElementById('inside-screen').innerHTML += `<br>Visitor: ${translated}`;
            if (currentMode === 'Visual' || currentMode === 'Universal') speak(translated, currentLanguage);
            document.getElementById('delivery-messages').style.display = 'none';
        }

        function sendMessage(message) {
            const translated = currentLanguage === 'Tamil' ? translations[message] : message;
            document.getElementById('visitor-screen').innerHTML += `<br>Resident: ${translated}`;
            if (currentMode === 'Visual' || currentMode === 'Universal') speak(translated, currentLanguage);
        }

        async function openCamera(videoId) {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    } 
                });
                const video = document.getElementById(videoId);
                video.srcObject = mediaStream;
                // Don't auto-start face detection anymore - wait for button click
            } catch (err) {
                document.getElementById('inside-screen').innerHTML += `<br>Error accessing camera: ${err.message}`;
            }
        }

        document.getElementById('off-camera').addEventListener('click', () => {
            stopMedia('inside-video');
            document.getElementById('inside-screen').innerHTML += '<br>Inside camera turned off.';
        });

        function stopMedia(videoId) {
            const video = document.getElementById(videoId);
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            if (videoId === 'visitor-video') {
                stopContinuousFaceDetection();
                mediaStream = null;
            }
        }

        function showPopup() {
            document.getElementById('speak-popup').classList.add('active');
        }

        function closePopup() {
            document.getElementById('speak-popup').classList.remove('active');
        }

        let isSpeaking = false;
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        const insideSpeakBtn = document.getElementById('inside-speak');
        insideSpeakBtn.addEventListener('click', () => {
            if (!isSpeaking) {
                showPopup();
                recognition.lang = currentLanguage === 'Tamil' ? 'ta-IN' : 'en-US';
                recognition.start();
                isSpeaking = true;
                insideSpeakBtn.classList.add('pressed');
                document.getElementById('inside-screen').innerHTML += '<br>Speaking mode started...';
            } else {
                recognition.stop();
                closePopup();
                isSpeaking = false;
                insideSpeakBtn.classList.remove('pressed');
                document.getElementById('inside-screen').innerHTML += '<br>Speaking mode stopped.';
            }
        });

        recognition.onresult = (event) => {
            const speechResult = event.results[event.results.length - 1][0].transcript;
            const translated = currentLanguage === 'Tamil' ? translations[speechResult] || speechResult : speechResult;
            document.getElementById('visitor-screen').innerHTML += `<br>Resident: ${translated}`;
            if (currentMode === 'Visual' || currentMode === 'Universal') speak(translated, currentLanguage);
        };

        recognition.onerror = (event) => {
            document.getElementById('inside-screen').innerHTML += `<br>Speech recognition error: ${event.error}`;
        };

        let isVisitorSpeaking = false;
        const visitorRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        visitorRecognition.continuous = true;
        visitorRecognition.interimResults = false;
        visitorRecognition.lang = 'en-US';
        const visitorSpeakBtn = document.getElementById('visitor-speak');
        visitorSpeakBtn.addEventListener('click', () => {
            if (!isVisitorSpeaking) {
                showPopup();
                visitorRecognition.lang = currentLanguage === 'Tamil' ? 'ta-IN' : 'en-US';
                visitorRecognition.start();
                isVisitorSpeaking = true;
                visitorSpeakBtn.classList.add('pressed');
                document.getElementById('visitor-screen').innerHTML += '<br>Speaking mode started...';
            } else {
                visitorRecognition.stop();
                closePopup();
                isVisitorSpeaking = false;
                visitorSpeakBtn.classList.remove('pressed');
                document.getElementById('visitor-screen').innerHTML += '<br>Speaking mode stopped.';
            }
        });

        visitorRecognition.onresult = (event) => {
            const speechResult = event.results[event.results.length - 1][0].transcript;
            const translated = currentLanguage === 'Tamil' ? translations[speechResult] || speechResult : speechResult;
            document.getElementById('inside-screen').innerHTML += `<br>Visitor: ${translated}`;
            if (currentMode === 'Visual' || currentMode === 'Universal') speak(translated, currentLanguage);
        };

        visitorRecognition.onerror = (event) => {
            document.getElementById('visitor-screen').innerHTML += `<br>Speech recognition error: ${event.error}`;
        };

        document.getElementById('inside-help').addEventListener('click', () => {
            helpClickCount++;
            if (helpTimer) clearTimeout(helpTimer);
            helpTimer = setTimeout(() => {
                handleHelp(helpClickCount);
                helpClickCount = 0;
            }, 500);
        });

        function handleHelp(taps) {
            let action = '';
            let number = '';
            let type = '';
            if (taps === 1) {
                action = 'Call to security';
                number = 'local-security-number';
                type = 'police';
            } else if (taps === 2) {
                action = 'Call/SMS to 112';
                number = '112';
                type = 'medical';
            } else {
                document.getElementById('inside-screen').innerHTML += '<br>Invalid taps';
                return;
            }
            
            // Open speak mode when SOS is triggered from wristband
            if (!isSpeaking) {
                showPopup();
                recognition.lang = currentLanguage === 'Tamil' ? 'ta-IN' : 'en-US';
                recognition.start();
                isSpeaking = true;
                insideSpeakBtn.classList.add('pressed');
                document.getElementById('inside-screen').innerHTML += '<br>Speaking mode started for emergency...';
            }
            
            const message = `${action} - ${type} help`;
            if (currentMode === 'Visual') {
                document.getElementById('inside-screen').innerHTML += `<br>${message}`;
                speak(message, currentLanguage);
            } else if (currentMode === 'Hearing') {
                const body = `Need ${type} help at [location]`;
                document.getElementById('inside-screen').innerHTML += `<br>${action} - Sending SMS to ${number}: ${body}`;
            } else {
                document.getElementById('inside-screen').innerHTML += `<br>${message}`;
                speak(message, currentLanguage);
            }
            setLEDs('red');
        }

        document.getElementById('inside-language').addEventListener('click', () => {
            languageTapCount++;
            if (languageTimer) clearTimeout(languageTimer);
            languageTimer = setTimeout(() => {
                if (languageTapCount === 1) {
                    currentLanguage = 'English';
                    document.getElementById('inside-screen').innerHTML += '<br>Language set to: English';
                } else if (languageTapCount === 2) {
                    currentLanguage = 'Tamil';
                    document.getElementById('inside-screen').innerHTML += '<br>Language set to: Tamil';
                }
                languageTapCount = 0;
            }, 500);
        });

        document.getElementById('inside-mode').addEventListener('click', () => {
            modeTapCount++;
            if (modeTimer) clearTimeout(modeTimer);
            modeTimer = setTimeout(() => {
                if (modeTapCount === 1) {
                    setMode('Universal');
                } else if (modeTapCount === 2) {
                    setMode('Visual');
                } else if (modeTapCount === 3) {
                    setMode('Hearing');
                }
                modeTapCount = 0;
            }, 500);
        });

        let sosClickCount = 0;
        let sosTimer = null;
        document.getElementById('wristband-sos').addEventListener('click', () => {
            sosClickCount++;
            if (sosTimer) clearTimeout(sosTimer);
            sosTimer = setTimeout(() => {
                handleHelp(sosClickCount);
                sosClickCount = 0;
            }, 500);
        });

        document.getElementById('inside-camera').addEventListener('click', () => openCamera('inside-video'));
        document.getElementById('visitor-camera').addEventListener('click', () => openCamera('visitor-video'));

        document.getElementById('inside-message').addEventListener('click', () => {
            const message = prompt('Type your message:');
            if (message && message.trim() !== '') {
                const translated = currentLanguage === 'Tamil' ? translations[message] || message : message;
                document.getElementById('visitor-screen').innerHTML += `<br>Resident: ${translated}`;
                if (currentMode === 'Visual' || currentMode === 'Universal') speak(translated, currentLanguage);
            }
        });

        function updateDateTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = months[now.getMonth()];
            const day = now.getDate();
            
            document.getElementById('wristband-time').textContent = `Time: ${hours}:${minutes} | Date: ${month} ${day}`;
        }

        // Update time immediately and then every minute
        updateDateTime();
        setInterval(updateDateTime, 60000);

        function fireAlarm() {
            setLEDs('red');
            const msg = currentLanguage === "English" ? "Fire Emergency Detected!" : translations["Fire Emergency Detected!"];
            document.getElementById('inside-screen').innerHTML = msg;
            document.getElementById('visitor-screen').innerHTML = msg;
            if (currentMode === 'Visual' || currentMode === 'Universal') speak(msg, currentLanguage);
            if (currentMode === 'Hearing' || currentMode === 'Universal') triggerWristbandAlert();
        }

        setLEDs('off');
    </script>
</body>
</html>