<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inclusive Smart Intercom Prototype</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #e0f7fa;
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding: 20px;
            flex-wrap: wrap;
        }
        .intercom {
            width: 420px;
            border: 2px solid #00acc1;
            padding: 15px;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin: 10px;
        }
        .screen {
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
            padding: 15px;
            margin-bottom: 15px;
            height: 220px;
            overflow-y: auto;
            font-size: 16px;
            border-radius: 10px;
        }
        .large-text {
            font-size: 24px;
            font-weight: bold;
            color: #01579b;
        }
        .leds {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }
        .led {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin: 0 8px;
            border: 2px solid #424242;
            transition: all 0.3s ease;
        }
        .led.green { background-color: #4caf50; }
        .led.yellow { background-color: #ffeb3b; }
        .led.red { background-color: #f44336; }
        .led.off { background-color: #9e9e9e; }
        .camera {
            text-align: center;
            margin-bottom: 15px;
            font-style: italic;
            color: #0277bd;
            cursor: pointer;
            background-color: #e1f5fe;
            padding: 10px;
            border-radius: 8px;
        }
        .speaker {
            text-align: left;
            margin-bottom: 15px;
            color: #0277bd;
        }
        .buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: #03a9f4;
            color: white;
            font-weight: bold;
            transition: background-color 0.3s;
            margin: 5px 0;
        }
        button:hover {
            background-color: #0288d1;
        }
        .braille-label {
            font-size: 12px;
            color: #757575;
            display: block;
        }
        .wristband {
            width: 220px;
            border: 2px solid #00acc1;
            padding: 15px;
            background-color: #ffffff;
            border-radius: 15px;
            text-align: center;
            margin: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .wristband-screen {
            background-color: #212121;
            color: #76ff03;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        #visitor-options, #pre-recorded {
            margin-top: 15px;
        }
        #pre-recorded button {
            display: block;
            width: 100%;
            margin: 8px 0;
        }
        video {
            width: 100%;
            height: auto;
            border-radius: 10px;
            margin-top: 10px;
        }
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border: 2px solid #00acc1;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }
        .popup.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="intercom" id="inside-intercom">
        <h2>Inside Intercom</h2>
        <div class="leds">
            <div class="led off" id="inside-green"></div>
            <div class="led off" id="inside-yellow"></div>
            <div class="led off" id="inside-red"></div>
        </div>
        <div class="camera" id="inside-camera">Camera (Click to Open)</div>
        <video id="inside-video" autoplay playsinline></video>
        <div class="screen large-text" id="inside-screen">
            Waiting for visitor...
        </div>
        <div class="speaker">Speaker (Audio Output)</div>
        <div class="buttons">
            <button id="inside-speak">Speak <span class="braille-label">(Braille: speak)</span></button>
            <button id="inside-help">Help <span class="braille-label">(Braille: help)</span></button>
            <button id="inside-language">Language (1: Eng, 2: Reg) <span class="braille-label">(Braille: lang)</span></button>
        </div>
        <div id="pre-recorded">
            Pre-recorded Messages:
            <button onclick="sendMessage('Leave it outside, I\'ll pick it up, thank you')">Leave it outside...</button>
            <button onclick="sendMessage('Thank you')">Thank you</button>
            <button onclick="sendMessage('Wait')">Wait</button>
            <button onclick="sendMessage('Have a nice day')">Have a nice day</button>
            <button onclick="sendMessage('How are you?')">How are you?</button>
            <button onclick="sendMessage('I\'m good')">I'm good</button>
            <button onclick="sendMessage('I need help with something')">I need help...</button>
        </div>
        <select id="inside-mode" onchange="setMode(this.value)">
            <option value="Universal">Universal Mode</option>
            <option value="Visual">Visual Impairment Mode</option>
            <option value="Hearing">Hearing/Speech Impairment Mode</option>
        </select>
    </div>

    <div class="intercom" id="visitor-intercom">
        <h2>Visitor's Intercom</h2>
        <div class="leds">
            <div class="led off" id="visitor-green"></div>
            <div class="led off" id="visitor-yellow"></div>
            <div class="led off" id="visitor-red"></div>
        </div>
        <div class="camera" id="visitor-camera">Camera (Click to Open)</div>
        <video id="visitor-video" autoplay playsinline></video>
        <div class="screen large-text" id="visitor-screen">
            Select purpose...
        </div>
        <div class="speaker">Speaker (Audio Input/Output)</div>
        <div class="buttons">
            <button id="visitor-speak">Speak <span class="braille-label">(Braille: speak)</span></button>
        </div>
        <div id="visitor-options">
            Options:
            <button onclick="selectPurpose('Parcel')">Parcel</button>
            <button onclick="selectPurpose('Delivery')">Delivery</button>
            <button onclick="selectPurpose('Security')">Security</button>
        </div>
        <select id="visitor-language" onchange="setVisitorLanguage(this.value)">
            <option value="English">English</option>
            <option value="Tamil">Tamil (Regional)</option>
        </select>
    </div>

    <div class="wristband">
        <h3>Wristband</h3>
        <div class="wristband-screen" id="wristband-time">Time: 12:00 | Date: Oct 7</div>
        <div class="leds">
            <div class="led off" id="wristband-green"></div>
            <div class="led off" id="wristband-yellow"></div>
            <div class="led off" id="wristband-red"></div>
        </div>
        <button id="wristband-sos">SOS <span class="braille-label">(Braille: sos)</span></button>
        <div id="wristband-alert">Vibration Alert: Off</div>
    </div>

    <div class="popup" id="speak-popup">
        <p>You can speak now. Click Speak again to stop.</p>
        <button onclick="closePopup()">Close</button>
    </div>

    <script>
        // Simulated data
        const translations = {
            "I have come to deliver the parcel": "நான் பர்சலை தர வந்திருக்கிறேன்"
        };
        let currentLanguage = "English";
        let currentMode = "Universal";
        let visitorPurpose = "";
        let ledColor = "off";
        let mediaStream = null;
        let helpClickCount = 0;
        let helpTimer = null;

        // Set LED lights
        function setLEDs(color) {
            ledColor = color || ['green', 'yellow', 'red'][Math.floor(Math.random() * 3)];
            document.querySelectorAll('.led').forEach(led => led.classList.remove('green', 'yellow', 'red', 'off'));
            if (color !== 'off') {
                document.getElementById('inside-' + ledColor).classList.add(ledColor);
                document.getElementById('visitor-' + ledColor).classList.add(ledColor);
                document.getElementById('wristband-' + ledColor).classList.add(ledColor);
                triggerWristbandAlert();
            } else {
                document.querySelectorAll('.led').forEach(led => led.classList.add('off'));
            }
        }

        // Trigger wristband vibration alert (simulated)
        function triggerWristbandAlert() {
            document.getElementById('wristband-alert').textContent = `Vibration Alert: On (${ledColor.toUpperCase()})`;
            setTimeout(() => {
                document.getElementById('wristband-alert').textContent = 'Vibration Alert: Off';
            }, 3000);
        }

        // Set mode
        function setMode(mode) {
            currentMode = mode;
            alert(`Mode set to: ${mode}`);
            if (mode === 'Visual') {
                alert('Audio wave icon shown');
            } else if (mode === 'Hearing') {
                alert('Vibration icon shown');
                triggerWristbandAlert();
            } else {
                alert('Combined icons shown');
                triggerWristbandAlert();
            }
        }

        // Visitor selects purpose
        function selectPurpose(purpose) {
            visitorPurpose = purpose;
            document.getElementById('visitor-screen').innerHTML = `Purpose: ${purpose}<br>Waiting for response...`;
            setLEDs('yellow');
            simulateVisitorAtDoor();
        }

        // Simulate visitor at door
        function simulateVisitorAtDoor() {
            document.getElementById('inside-screen').innerHTML = `
                Visitor: Delivery person with parcel<br>
                Purpose: ${visitorPurpose}<br>
                Subtitles: "நான் பர்சலை தர வந்திருக்கிறேன்" (if Tamil)
            `;
        }

        // Send pre-recorded message
        function sendMessage(message) {
            let transMessage = currentLanguage === "English" ? message : translations[message] || message + ' (translated)';
            document.getElementById('visitor-screen').innerHTML += `<br>Resident: ${transMessage}`;
            alert(`Message played outside: ${transMessage}`);
        }

        // Set visitor language
        function setVisitorLanguage(lang) {
            currentLanguage = lang;
            alert(`Visitor language set to: ${lang}`);
        }

        // Open camera
        async function openCamera(videoId) {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.getElementById(videoId);
                video.srcObject = mediaStream;
            } catch (err) {
                alert('Error accessing camera: ' + err.message);
            }
        }

        // Stop media
        function stopMedia() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            document.querySelectorAll('video').forEach(v => v.srcObject = null);
        }

        // Show popup
        function showPopup() {
            document.getElementById('speak-popup').classList.add('active');
        }

        // Close popup
        function closePopup() {
            document.getElementById('speak-popup').classList.remove('active');
        }

        // Inside speak button (toggle speak mode)
        let isSpeaking = false;
        document.getElementById('inside-speak').addEventListener('click', async () => {
            if (!isSpeaking) {
                showPopup();
                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    isSpeaking = true;
                    alert('Microphone activated. Speaking now...');
                } catch (err) {
                    alert('Error accessing microphone: ' + err.message);
                }
            } else {
                stopMedia();
                closePopup();
                isSpeaking = false;
                alert('Speak mode stopped.');
            }
        });

        // Visitor speak button
        document.getElementById('visitor-speak').addEventListener('click', async () => {
            const speech = prompt('Enter visitor speech:');
            if (speech) {
                let trans = currentLanguage === "English" ? speech : translations[speech] || speech + ' (translated)';
                document.getElementById('inside-screen').innerHTML += `<br>Visitor: ${trans}`;
            }
        });

        // Help button with tap detection
        document.getElementById('inside-help').addEventListener('click', () => {
            helpClickCount++;
            if (helpTimer) clearTimeout(helpTimer);
            helpTimer = setTimeout(() => {
                handleHelp(helpClickCount);
                helpClickCount = 0;
            }, 500); // Detect taps within 500ms
        });

        function handleHelp(taps) {
            let action = '';
            let number = '';
            let type = '';
            if (taps === 1) {
                action = 'Call to security';
                number = 'local-security-number'; // Simulate
                type = 'police';
            } else if (taps === 2) {
                action = 'Call/SMS to 112';
                number = '112';
                type = 'medical'; // Or prompt for type
            } else if (taps === 3) {
                action = 'Call/SMS to emergency';
                number = '112';
                type = 'fire';
            } else {
                alert('Invalid taps');
                return;
            }

            if (currentMode === 'Visual') {
                // Simulate call
                alert(`${action} - Calling ${number} for ${type} help.`);
                // In real: window.location = `tel:${number}`;
            } else if (currentMode === 'Hearing') {
                // Simulate SMS
                const body = `Need ${type} help at [location]`;
                alert(`${action} - Sending SMS to ${number}: ${body}`);
                // In real: window.location = `sms:${number}?body=${encodeURIComponent(body)}`;
            } else {
                // Universal: Prompt or default to call
                alert(`${action} - Universal mode: Calling ${number} for ${type} help.`);
            }
        }

        // Language button (inside)
        document.getElementById('inside-language').addEventListener('click', () => {
            const choice = parseInt(prompt('Press 1 for English, 2 for Regional:'));
            currentLanguage = choice === 1 ? 'English' : 'Tamil';
            alert(`Language set to: ${currentLanguage}`);
        });

        // Wristband SOS (similar to help)
        let sosClickCount = 0;
        let sosTimer = null;
        document.getElementById('wristband-sos').addEventListener('click', () => {
            sosClickCount++;
            if (sosTimer) clearTimeout(sosTimer);
            sosTimer = setTimeout(() => {
                handleHelp(sosClickCount); // Reuse handleHelp
                sosClickCount = 0;
            }, 500);
        });

        // Camera clicks
        document.getElementById('inside-camera').addEventListener('click', () => openCamera('inside-video'));
        document.getElementById('visitor-camera').addEventListener('click', () => openCamera('visitor-video'));

        // Initial setup
        setLEDs('off');
    </script>
</body>
</html> -->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inclusive Smart Intercom Prototype</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #e0f7fa;
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding: 20px;
            flex-wrap: wrap;
        }
        .intercom {
            width: 420px;
            border: 2px solid #00acc1;
            padding: 15px;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin: 10px;
        }
        .screen {
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
            padding: 15px;
            margin-bottom: 15px;
            height: 220px;
            overflow-y: auto;
            font-size: 16px;
            border-radius: 10px;
        }
        .large-text {
            font-size: 24px;
            font-weight: bold;
            color: #01579b;
        }
        .leds {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }
        .led {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin: 0 8px;
            border: 2px solid #424242;
            transition: all 0.3s ease;
        }
        .led.green { background-color: #4caf50; }
        .led.yellow { background-color: #ffeb3b; }
        .led.red { background-color: #f44336; }
        .led.off { background-color: #9e9e9e; }
        .camera {
            text-align: center;
            margin-bottom: 15px;
            font-style: italic;
            color: #0277bd;
            cursor: pointer;
            background-color: #e1f5fe;
            padding: 10px;
            border-radius: 8px;
        }
        .speaker {
            text-align: left;
            margin-bottom: 15px;
            color: #0277bd;
        }
        .buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: #03a9f4;
            color: white;
            font-weight: bold;
            transition: background-color 0.3s;
            margin: 5px 0;
        }
        button:hover {
            background-color: #0288d1;
        }
        .braille-label {
            font-size: 12px;
            color: #757575;
            display: block;
        }
        .wristband {
            width: 220px;
            border: 2px solid #00acc1;
            padding: 15px;
            background-color: #ffffff;
            border-radius: 15px;
            text-align: center;
            margin: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .wristband-screen {
            background-color: #212121;
            color: #76ff03;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        #visitor-options, #pre-recorded, #delivery-messages {
            margin-top: 15px;
        }
        #pre-recorded button, #delivery-messages button {
            display: block;
            width: 100%;
            margin: 8px 0;
        }
        video {
            width: 100%;
            height: auto;
            border-radius: 10px;
            margin-top: 10px;
        }
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border: 2px solid #00acc1;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }
        .popup.active {
            display: block;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.7.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>
    <div class="intercom" id="inside-intercom">
        <h2>Inside Intercom</h2>
        <div class="leds">
            <div class="led off" id="inside-green"></div>
            <div class="led off" id="inside-yellow"></div>
            <div class="led off" id="inside-red"></div>
        </div>
        <div class="camera" id="inside-camera">Camera (Click to Open)</div>
        <div class="camera" id="off-camera">Off Camera</div>
        <video id="inside-video" autoplay playsinline></video>
        <div class="screen large-text" id="inside-screen">
            Waiting for visitor...
        </div>
        <div class="speaker">Speaker (Audio Output)</div>
        <div class="buttons">
            <button id="inside-speak">Speak <span class="braille-label">(Braille: speak)</span></button>
            <button id="inside-help">Help <span class="braille-label">(Braille: help)</span></button>
            <button id="add-face">Add Face <span class="braille-label">(Braille: face)</span></button>
            <button id="inside-language">Language <span class="braille-label">(Braille: lang)</span></button>
        </div>
        <div id="pre-recorded">
            Pre-recorded Messages:
            <button onclick="sendMessage('Leave it outside, I\'ll pick it up, thank you')">Leave it outside...</button>
            <button onclick="sendMessage('Thank you')">Thank you</button>
            <button onclick="sendMessage('Wait')">Wait</button>
            <button onclick="sendMessage('Have a nice day')">Have a nice day</button>
            <button onclick="sendMessage('I\'m coming')">I'm coming</button>
            <button onclick="sendMessage('I need help with something')">I need help...</button>
        </div>
        <select id="inside-mode" onchange="setMode(this.value)">
            <option value="Universal">Universal Mode</option>
            <option value="Visual">Visual Impairment Mode</option>
            <option value="Hearing">Hearing/Speech Impairment Mode</option>
        </select>
    </div>
    <div class="intercom" id="visitor-intercom">
        <h2>Visitor's Intercom</h2>
        <div class="leds">
            <div class="led off" id="visitor-green"></div>
            <div class="led off" id="visitor-yellow"></div>
            <div class="led off" id="visitor-red"></div>
        </div>
        <div class="camera" id="visitor-camera">Camera (Click to Open)</div>
        <video id="visitor-video" autoplay playsinline></video>
        <div class="screen large-text" id="visitor-screen">
            Select purpose...
        </div>
        <div class="speaker">Speaker (Audio Input/Output)</div>
        <div class="buttons">
            <button id="visitor-speak">Speak <span class="braille-label">(Braille: speak)</span></button>
        </div>
        <div id="visitor-options">
            Options:
            <button onclick="selectPurpose('Delivery')">Delivery</button>
            <button onclick="selectPurpose('Family Member')">Family Member</button>
            <button onclick="selectPurpose('Friend')">Friend</button>
            <button onclick="selectPurpose('Neighbour')">Neighbour</button>
        </div>
        <div id="delivery-messages" style="display: none;">
            Delivery Messages:
            <button onclick="sendDeliveryMessage('Parcel for you')">Parcel for you</button>
            <button onclick="sendDeliveryMessage('Please come outside')">Please come outside</button>
            <button onclick="sendDeliveryMessage('I have reached')">I have reached</button>
        </div>
    </div>
    <div class="wristband">
        <h3>Wristband</h3>
        <div class="wristband-screen" id="wristband-time">Time: 12:00 | Date: Oct 7</div>
        <div class="leds">
            <div class="led off" id="wristband-green"></div>
            <div class="led off" id="wristband-yellow"></div>
            <div class="led off" id="wristband-red"></div>
        </div>
        <button id="wristband-sos">SOS <span class="braille-label">(Braille: sos)</span></button>
        <div id="wristband-alert">Vibration Alert: Off</div>
    </div>
    <div class="popup" id="speak-popup">
        <p>You can speak now. Click Speak again to stop.</p>
        <button onclick="closePopup()">Close</button>
    </div>
    <script>
        const translations = {
            "has arrived": "வந்திருக்கிறார்",
            "Delivery person is at the door": "டெலிவரி நபர் வாசலில் உள்ளார்",
            "Parcel for you": "உங்களுக்கு பர்சல்",
            "Please come outside": "தயவு செய்து வெளியே வாருங்கள்",
            "I have reached": "நான் சேர்ந்துவிட்டேன்",
            "Leave it outside, I'll pick it up, thank you": "அதை வெளியே வைக்கவும், நான் எடுத்துக் கொள்கிறேன், நன்றி",
            "Thank you": "நன்றி",
            "Wait": "காத்திருங்கள்",
            "Have a nice day": "நல்வாழ்த்துக்கள்",
            "I'm coming": "நான் வருகிறேன்",
            "I need help with something": "எனக்கு ஏதாவது உதவி தேவை",
            "Fire Emergency Detected!": "தீ அபாயம் கண்டறியப்பட்டது!"
        };
        let knownPeople = [];
        let currentLanguage = "English";
        let currentMode = "Universal";
        let visitorPurpose = "";
        let ledColor = "off";
        let mediaStream = null;
        let helpClickCount = 0;
        let helpTimer = null;
        let languageTapCount = 0;
        let languageTimer = null;
        let modelsLoaded = false;
        async function loadModels() {
            try {
                console.log('Starting model loading...');
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri('./models'),
                    faceapi.nets.faceLandmark68Net.loadFromUri('./models'),
                    faceapi.nets.faceRecognitionNet.loadFromUri('./models')
                ]);
                modelsLoaded = true;
                console.log('Models loaded successfully!');
                document.getElementById('inside-screen').innerHTML += '<br>Face recognition ready.';
            } catch (err) {
                console.error('Model loading error:', err);
                document.getElementById('inside-screen').innerHTML += '<br>Error loading models: ' + err.message;
            }
        }
        loadModels();
        function speak(text, lang) {
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = (lang === "Tamil") ? "ta-IN" : "en-US";
            utter.volume = 1;
            utter.rate = 0.9;
            utter.pitch = 1;
            speechSynthesis.speak(utter);
        }
        function setLEDs(color) {
            ledColor = color || ['green', 'yellow', 'red'][Math.floor(Math.random() * 3)];
            document.querySelectorAll('.led').forEach(led => led.classList.remove('green', 'yellow', 'red', 'off'));
            if (color !== 'off') {
                document.getElementById('inside-' + ledColor).classList.add(ledColor);
                document.getElementById('visitor-' + ledColor).classList.add(ledColor);
                document.getElementById('wristband-' + ledColor).classList.add(ledColor);
                triggerWristbandAlert();
            } else {
                document.querySelectorAll('.led').forEach(led => led.classList.add('off'));
            }
        }
        function triggerWristbandAlert() {
            const message = ledColor === 'green' ? 'Known person' : ledColor === 'yellow' ? 'Delivery' : 'Emergency';
            document.getElementById('wristband-alert').textContent = `Vibration Alert: On (${message})`;
            setTimeout(() => {
                document.getElementById('wristband-alert').textContent = 'Vibration Alert: Off';
            }, 3000);
        }
        function setMode(mode) {
            currentMode = mode;
            document.getElementById('inside-screen').innerHTML += `<br>Mode set to: ${mode}`;
            if (mode === 'Visual') {
                document.getElementById('inside-screen').innerHTML += '<br>Audio wave icon shown';
            } else if (mode === 'Hearing') {
                document.getElementById('inside-screen').innerHTML += '<br>Vibration icon shown';
                triggerWristbandAlert();
            } else {
                document.getElementById('inside-screen').innerHTML += '<br>Combined icons shown';
                triggerWristbandAlert();
            }
        }
        document.getElementById('add-face').addEventListener('click', async () => {
            if (!modelsLoaded) {
                document.getElementById('inside-screen').innerHTML += '<br>Models not loaded yet. Please wait.';
                return;
            }
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                const name = prompt("Enter name (e.g., Ravi):");
                const category = prompt("Enter category (Family Member, Friend, Neighbour):");
                if (file && name && category && ['Family Member', 'Friend', 'Neighbour'].includes(category)) {
                    try {
                        const img = await faceapi.bufferToImage(file);
                        console.log('Attempting face detection on image...');
                        const detection = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                        if (detection) {
                            knownPeople.push({ name, category, descriptor: detection.descriptor });
                            console.log('Added person:', name, knownPeople.length);
                            document.getElementById('inside-screen').innerHTML += `<br>${name} (${category}) face added.`;
                        } else {
                            console.log('No face detected in image');
                            document.getElementById('inside-screen').innerHTML += '<br>No face detected in the image.';
                        }
                    } catch (err) {
                        console.error('Error processing image:', err);
                        document.getElementById('inside-screen').innerHTML += '<br>Error processing image: ' + err.message;
                    }
                } else {
                    document.getElementById('inside-screen').innerHTML += '<br>Invalid input or category! Use Family Member, Friend, or Neighbour.';
                }
            };
            input.click();
        });
        function selectPurpose(purpose) {
            visitorPurpose = purpose;
            document.getElementById('visitor-screen').innerHTML = `Purpose: ${purpose}<br>Waiting for response...`;
            if (purpose === 'Delivery') {
                document.getElementById('delivery-messages').style.display = 'block';
            } else {
                document.getElementById('delivery-messages').style.display = 'none';
                if (modelsLoaded) checkFaceRecognition();
                else document.getElementById('inside-screen').innerHTML += '<br>Models not loaded yet. Please wait.';
            }
        }
        async function checkFaceRecognition() {
            if (!modelsLoaded || !mediaStream || knownPeople.length === 0) {
                console.log('Cannot check recognition: Models not loaded, no stream, or no known people');
                simulateVisitorAtDoor(null, 'yellow');
                return;
            }
            const video = document.getElementById('visitor-video');
            try {
                const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                console.log('Detections:', detections.length);
                if (detections.length > 0) {
                    const faceDescriptor = detections[0].descriptor;
                    const match = knownPeople.find(person => {
                        const distance = faceapi.euclideanDistance(faceDescriptor, person.descriptor);
                        console.log('Distance to', person.name, ':', distance);
                        return distance < 0.8;
                    });
                    if (match) {
                        simulateVisitorAtDoor(match.name, 'green');
                    } else {
                        simulateVisitorAtDoor(null, 'yellow');
                    }
                } else {
                    console.log('No faces detected in video');
                    simulateVisitorAtDoor(null, 'yellow');
                }
            } catch (err) {
                console.error('Face detection error:', err);
                document.getElementById('inside-screen').innerHTML += '<br>Face detection failed: ' + err.message;
            }
        }
        function simulateVisitorAtDoor(name = null, color = 'yellow') {
            let message = name ? `${name} has arrived` : "Unknown person at the door";
            if (visitorPurpose === 'Delivery') message = "Delivery person is at the door";
            const translated = currentLanguage === 'Tamil' ? translations[message] || message + ' (translated)' : message;
            document.getElementById('inside-screen').innerHTML = `
                Visitor: ${translated}<br>
                Purpose: ${visitorPurpose || 'Unknown'}
            `;
            setLEDs(color);
            if (currentMode === 'Visual' || currentMode === 'Universal') speak(translated, currentLanguage);
            if (currentMode === 'Hearing' || currentMode === 'Universal') triggerWristbandAlert();
        }
        function sendDeliveryMessage(message) {
            const translated = currentLanguage === 'Tamil' ? translations[message] : message;
            document.getElementById('inside-screen').innerHTML += `<br>Visitor: ${translated}`;
            if (currentMode === 'Visual' || currentMode === 'Universal') speak(translated, currentLanguage);
            document.getElementById('delivery-messages').style.display = 'none';
        }
        function sendMessage(message) {
            const translated = currentLanguage === 'Tamil' ? translations[message] : message;
            document.getElementById('visitor-screen').innerHTML += `<br>Resident: ${translated}`;
            if (currentMode === 'Visual' || currentMode === 'Universal') speak(translated, currentLanguage);
        }
        async function openCamera(videoId) {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.getElementById(videoId);
                video.srcObject = mediaStream;
                if (videoId === 'visitor-video' && modelsLoaded) {
                    setTimeout(() => {
                        console.log('Checking face recognition...');
                        checkFaceRecognition();
                    }, 2000);
                }
            } catch (err) {
                document.getElementById('inside-screen').innerHTML += `<br>Error accessing camera: ${err.message}`;
            }
        }
        document.getElementById('off-camera').addEventListener('click', () => {
            stopMedia('inside-video');
            document.getElementById('inside-screen').innerHTML += '<br>Inside camera turned off.';
        });
        function stopMedia(videoId) {
            const video = document.getElementById(videoId);
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }
        function showPopup() {
            document.getElementById('speak-popup').classList.add('active');
        }
        function closePopup() {
            document.getElementById('speak-popup').classList.remove('active');
        }
        let isSpeaking = false;
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        document.getElementById('inside-speak').addEventListener('click', () => {
            if (!isSpeaking) {
                showPopup();
                recognition.lang = currentLanguage === 'Tamil' ? 'ta-IN' : 'en-US';
                recognition.start();
                isSpeaking = true;
                document.getElementById('inside-screen').innerHTML += '<br>Speaking mode started...';
            } else {
                recognition.stop();
                stopMedia();
                closePopup();
                isSpeaking = false;
                document.getElementById('inside-screen').innerHTML += '<br>Speaking mode stopped.';
            }
        });
        recognition.onresult = (event) => {
            const speechResult = event.results[event.results.length - 1][0].transcript;
            const translated = currentLanguage === 'Tamil' ? translations[speechResult] || speechResult + ' (translated)' : speechResult;
            document.getElementById('inside-screen').innerHTML += `<br>Spoken: ${translated}`;
            if (currentMode === 'Visual' || currentMode === 'Universal') speak(translated, currentLanguage);
        };
        recognition.onerror = (event) => {
            document.getElementById('inside-screen').innerHTML += `<br>Speech recognition error: ${event.error}`;
        };
        let isVisitorSpeaking = false;
        const visitorRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        visitorRecognition.continuous = true;
        visitorRecognition.interimResults = false;
        visitorRecognition.lang = 'en-US';
        document.getElementById('visitor-speak').addEventListener('click', () => {
            if (!isVisitorSpeaking) {
                showPopup();
                visitorRecognition.lang = currentLanguage === 'Tamil' ? 'ta-IN' : 'en-US';
                visitorRecognition.start();
                isVisitorSpeaking = true;
                document.getElementById('visitor-screen').innerHTML += '<br>Speaking mode started...';
            } else {
                visitorRecognition.stop();
                closePopup();
                isVisitorSpeaking = false;
                document.getElementById('visitor-screen').innerHTML += '<br>Speaking mode stopped.';
            }
        });
        visitorRecognition.onresult = (event) => {
            const speechResult = event.results[event.results.length - 1][0].transcript;
            const translated = currentLanguage === 'Tamil' ? translations[speechResult] || speechResult + ' (translated)' : speechResult;
            document.getElementById('inside-screen').innerHTML += `<br>Visitor: ${translated}`;
            if (currentMode === 'Visual' || currentMode === 'Universal') speak(translated, currentLanguage);
        };
        visitorRecognition.onerror = (event) => {
            document.getElementById('visitor-screen').innerHTML += `<br>Speech recognition error: ${event.error}`;
        };
        document.getElementById('inside-help').addEventListener('click', () => {
            helpClickCount++;
            if (helpTimer) clearTimeout(helpTimer);
            helpTimer = setTimeout(() => {
                handleHelp(helpClickCount);
                helpClickCount = 0;
            }, 500);
        });
        function handleHelp(taps) {
            let action = '';
            let number = '';
            let type = '';
            if (taps === 1) {
                action = 'Call to security';
                number = 'local-security-number';
                type = 'police';
            } else if (taps === 2) {
                action = 'Call/SMS to 112';
                number = '112';
                type = 'medical';
            } else if (taps === 3) {
                action = 'Call/SMS to emergency';
                number = '112';
                type = 'fire';
            } else {
                document.getElementById('inside-screen').innerHTML += '<br>Invalid taps';
                return;
            }
            const message = `${action} - ${type} help`;
            if (currentMode === 'Visual') {
                document.getElementById('inside-screen').innerHTML += `<br>${message}`;
                speak(message, currentLanguage);
            } else if (currentMode === 'Hearing') {
                const body = `Need ${type} help at [location]`;
                document.getElementById('inside-screen').innerHTML += `<br>${action} - Sending SMS to ${number}: ${body}`;
            } else {
                document.getElementById('inside-screen').innerHTML += `<br>${message}`;
                speak(message, currentLanguage);
            }
            setLEDs('red');
        }
        document.getElementById('inside-language').addEventListener('click', () => {
            languageTapCount++;
            if (languageTimer) clearTimeout(languageTimer);
            languageTimer = setTimeout(() => {
                if (languageTapCount === 1) {
                    currentLanguage = 'English';
                    document.getElementById('inside-screen').innerHTML += '<br>Language set to: English';
                } else if (languageTapCount === 2) {
                    currentLanguage = 'Tamil';
                    document.getElementById('inside-screen').innerHTML += '<br>Language set to: Tamil';
                }
                languageTapCount = 0;
            }, 500);
        });
        let sosClickCount = 0;
        let sosTimer = null;
        document.getElementById('wristband-sos').addEventListener('click', () => {
            sosClickCount++;
            if (sosTimer) clearTimeout(sosTimer);
            sosTimer = setTimeout(() => {
                handleHelp(sosClickCount);
                sosClickCount = 0;
            }, 500);
        });
        document.getElementById('inside-camera').addEventListener('click', () => openCamera('inside-video'));
        document.getElementById('visitor-camera').addEventListener('click', () => openCamera('visitor-video'));
        function fireAlarm() {
            setLEDs('red');
            const msg = currentLanguage === "English" ? "Fire Emergency Detected!" : translations["Fire Emergency Detected!"];
            document.getElementById('inside-screen').innerHTML = msg;
            document.getElementById('visitor-screen').innerHTML = msg;
            if (currentMode === 'Visual' || currentMode === 'Universal') speak(msg, currentLanguage);
            if (currentMode === 'Hearing' || currentMode === 'Universal') triggerWristbandAlert();
        }
        setLEDs('off');
    </script>
</body>
</html>
